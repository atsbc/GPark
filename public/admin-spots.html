<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>GPark Admin - Manage Spots</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <h1>Manage Parking Spots</h1>
  <button id="logoutBtn">Logout</button>

  <form id="addSpotForm">
    <input type="text" id="newSpotId" placeholder="Enter new spot ID" required />
    <button type="submit">Add Spot</button>
  </form>

  <div style="margin: 1rem 0;">
    <button id="activateSelected" class="bulkBtn">Activate Selected</button>
    <button id="deactivateSelected" class="bulkBtn">Deactivate Selected</button>
    <button id="deleteSelected" class="bulkBtn delete">Delete Selected</button>
  </div>

  <table>
    <thead>
      <tr>
        <th><input type="checkbox" id="selectAll" /></th>
        <th>Spot ID</th>
        <th>Active</th>
      </tr>
    </thead>
    <tbody id="spotsList">
      <tr><td colspan="3">Loading spots...</td></tr>
    </tbody>
  </table>

  <script>
    let currentSpots = [];

    async function fetchSpots() {
      try {
        const res = await fetch('/admin/spots');
        if (!res.ok) throw new Error('Unauthorized');
        currentSpots = await res.json();
        const tbody = document.getElementById('spotsList');
        if (currentSpots.length === 0) {
          tbody.innerHTML = '<tr><td colspan="3">No spots found</td></tr>';
          return;
        }

        tbody.innerHTML = currentSpots.map((spot) => `
          <tr data-id="${spot.id}">
            <td><input type="checkbox" class="rowCheckbox" /></td>
            <td>${spot.id}</td>
            <td>${spot.active ? '✅' : '❌'}</td>
          </tr>
        `).join('');

        document.getElementById('selectAll').checked = false;
      } catch (err) {
        document.getElementById('spotsList').innerHTML = '<tr><td colspan="3">Failed to load spots</td></tr>';
      }
    }

    document.getElementById('addSpotForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const id = document.getElementById('newSpotId').value.trim();
      if (!id) return alert('Please enter a spot ID');
      try {
        const res = await fetch('/admin/spots', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id }),
        });
        const data = await res.json();
        if (!res.ok) return alert(data.error || 'Failed to add');
        document.getElementById('newSpotId').value = '';
        fetchSpots();
      } catch {
        alert('Error adding spot');
      }
    });

    document.getElementById('logoutBtn').addEventListener('click', async () => {
      await fetch('/admin/logout', { method: 'POST' });
      window.location.href = '/admin-login.html';
    });

    document.getElementById('selectAll').addEventListener('change', (e) => {
      document.querySelectorAll('.rowCheckbox').forEach(cb => {
        cb.checked = e.target.checked;
      });
    });

    function getSelectedIds() {
      const checkboxes = document.querySelectorAll('.rowCheckbox');
      return Array.from(checkboxes)
        .map((cb, i) => cb.checked ? currentSpots[i].id : null)
        .filter(Boolean);
    }

    async function bulkUpdate(active) {
      const ids = getSelectedIds();
      if (ids.length === 0) return alert('No spots selected');
      const updates = ids.map(id =>
        fetch(`/admin/spots/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ active }),
        })
      );
      await Promise.all(updates);
      fetchSpots();
    }

    async function bulkDelete() {
      const ids = getSelectedIds();
      if (ids.length === 0) return alert('No spots selected');
      if (!confirm(`Delete ${ids.length} spot(s)?`)) return;
      const deletions = ids.map(id =>
        fetch(`/admin/spots/${id}`, {
          method: 'DELETE'
        })
      );
      await Promise.all(deletions);
      fetchSpots();
    }

    document.getElementById('activateSelected').addEventListener('click', () => bulkUpdate(true));
    document.getElementById('deactivateSelected').addEventListener('click', () => bulkUpdate(false));
    document.getElementById('deleteSelected').addEventListener('click', () => bulkDelete());

    fetchSpots();
  </script>
</body>
</html>
