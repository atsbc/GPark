<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GPark Admin Dashboard</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <h1>GPark Admin Dashboard</h1>
  <button id="logoutBtn">Logout</button>

  <table>
    <thead>
      <tr>
        <th>Parking Spot</th>
        <th>Duration (minutes)</th>
        <th>License Plate</th>
        <th>Start Time</th>
        <th>Time Left</th>
      </tr>
    </thead>
    <tbody id="bookingList">
      <tr><td colspan="5">Loading bookings...</td></tr>
    </tbody>
  </table>

  <script>
    function formatDurationLeft(msLeft) {
      if (msLeft <= 0) return 'Expired';
      const totalMinutes = Math.floor(msLeft / (1000 * 60));
      const hours = Math.floor(totalMinutes / 60);
      const minutes = totalMinutes % 60;
      if (hours > 0) {
        return `${hours}h ${minutes}m left`;
      }
      return `${minutes}m left`;
    }

    async function fetchBookings() {
      try {
        const res = await fetch('/admin/bookings');
        if (!res.ok) throw new Error('Unauthorized');
        const bookings = await res.json();
        const tbody = document.getElementById('bookingList');

        if (bookings.length === 0) {
          tbody.innerHTML = '<tr><td colspan="5">No bookings found</td></tr>';
          return;
        }

        tbody.innerHTML = bookings.map((b, idx) => `
          <tr data-index="${idx}">
            <td>${b.parkingSpotId}</td>
            <td>${b.duration}</td>
            <td>${b.licensePlate}</td>
            <td>${new Date(b.timestamp).toLocaleString()}</td>
            <td class="timer" id="timer-${idx}">Loading...</td>
          </tr>
        `).join('');

        updateTimers(bookings);
        setInterval(() => updateTimers(bookings), 60000); // every minute
      } catch (err) {
        document.getElementById('bookingList').innerHTML = '<tr><td colspan="5">Failed to load bookings</td></tr>';
      }
    }

    function updateTimers(bookings) {
      const now = Date.now();
      bookings.forEach((booking, idx) => {
        const endTime = booking.timestamp + booking.duration * 60 * 1000;
        const msLeft = endTime - now;
        const timerEl = document.getElementById(`timer-${idx}`);
        if (timerEl) {
          timerEl.textContent = formatDurationLeft(msLeft);
        }
      });
    }

    document.getElementById('logoutBtn').addEventListener('click', async () => {
      await fetch('/admin/logout', { method: 'POST' });
      window.location.href = '/admin-login.html';
    });

    fetchBookings();
  </script>
</body>
</html>
